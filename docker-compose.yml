version: '3.9'

services:
  site:
    image: ${DOCKERHUB_USERNAME}/grdmad:${IMAGE_TAG}
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=network_public"

        # HTTP -> HTTPS
        - "traefik.http.routers.grdmad-web.rule=Host(`grdmad.com.br`,`www.grdmad.com.br`)"
        - "traefik.http.routers.grdmad-web.entrypoints=web"
        - "traefik.http.routers.grdmad-web.middlewares=grdmad-https-redirect"
        - "traefik.http.middlewares.grdmad-https-redirect.redirectscheme.scheme=https"
        - "traefik.http.middlewares.grdmad-https-redirect.redirectscheme.permanent=true"

        # HTTPS
        - "traefik.http.routers.grdmad-secure.rule=Host(`grdmad.com.br`,`www.grdmad.com.br`)"
        - "traefik.http.routers.grdmad-secure.entrypoints=websecure"
        - "traefik.http.routers.grdmad-secure.tls=true"
        - "traefik.http.routers.grdmad-secure.tls.certresolver=letsencryptresolver"

        # Porta interna do Nginx
        - "traefik.http.services.grdmad.loadbalancer.server.port=80"

    # Use caminho ABSOLUTO no Swarm (recomendado)
    volumes:
      - /var/www/grdmad/dist:/usr/share/nginx/html:ro

    networks:
      - network_public

networks:
  network_public:
    external: true
